## 동시성

### 1. 동시성이 필요한 이유
동시성은 결합을 없애는 전략이다. <br>
무엇과 언제를 분리하는 것 <br>
스레드가 하나인 프로그램은 무엇과 언제가 서로 밀접하다. <br>
그래서 호출 스택을 살펴보면 프로그램 상태가 곧바로 드러난다. <br>
싱글 스레드에서는 무엇과 언제가 서로 밀접하지만 이 둘을 분리하면 애플리케이션 구조와 효율이 극적으로 좋아진다. <br>

### 2. 동시성 방어 원칙
1. SRP
<br> 동시성은 복잡성 하나만으로도 따로 분리할 이유가 충분하다. 
<br> 즉, 동시성 관련 코드는 다른 코드와 분리해야한다는 뜻이다.
2. 자료 범위를 제한하라 - 공유 자료를 최소화
<br> 자료를 캡슐화하고 공유자료를 최대한 줄여라.
<br> 현대에는 불변객체 사용으로 공유 자료 문제 원천 차단
<br> 함수형 프로그래밍으로 상태 변경 최소화
<br> 스레드 로컬 스토리지 활용
<br> 메세지 패싱 방식 (웹플럭스, 이벤트 기반)
<br> 버츄얼 스레드(자바21)로 경량 스레드 대량 생성
<br> 코틀린 코루틴으로 구조화된 비동기 처리
<br> 로 해결하였다.
<br>

### 3. 라이브러리를 이해하라
| 라이브러리 | 설명 |
|---|---|
| ReentrantLock | 한 메서드에서 잠그고 다른 메서드에서 푸는 락이다. (현재 거의 직접 사용 안함) |
| Semaphore | 전형적인 세마포어. 개수가 있는 락이다. (현재 거의 직접 사용 안함) |
| CountDownLatch | 지정한 수만큼 이벤트가 발생하고 나서야 대기 중인 스레드를 모두 해제하는 락이다. 모든 스레드에게 동시에 공평하게 시작할 기회를 준다. |
| ConcurrentHashMap | 스레드 안전한 해시맵 |
| AtomicInteger/AtomicReference | 원자적 연산 |
| ExecutorService | 스레드풀 관리 |


### 4. 실행 모델을 이해하라
| 용어 | 설명 |
|---|---|
| 한정된 자원 (Bound Resource) | 다중 스레드 환경에서 사용하는 자원으로, 크기나 숫자가 제한적이다. 데이터베이스 연결, 길이가 일정한 읽기/쓰기 버퍼 등이 예다. |
| 상호 배제 (Mutual Exclusion) | 한번에 한 스레드만 공유자료나 공유자원을 사용할 수 있는 경우를 가리킨다. |
| 기아 (Starvation) | 한 스레드나 여러 스레드가 굉장히 오랫동안 혹은 영원히 자원을 기다린다. 예를 들어, 항상 짧은 스레드에게 우선순위를 준다면, 짧은 스레드가 지속적으로 이어질 경우 긴 스레드가 기아상태에 빠진다. |
| 데드락 (Deadlock) | 여러 스레드가 서로가 끝나기를 기다린다. 모든 스레드가 각기 필요한 자원을 다른 스레드가 점유하는 바람에 어느쪽도 더이상 진행하지 못한다. |
| 라이브락 (Livelock) | 락을 거는 단계에서 각 스레드가 서로를 방해한다. 스레드는 계속해서 진행하려 하지만 공명(resonance)으로 인해 굉장히 오랫동안 혹은 영원히 진행하지 못한다. |


### 5. 동기화하는 메서드 사이에 존재하는 의존성을 이해하라
동기화하는 메서드 사이에 의존성이 존재하면 동시성 코드에 찾아내기 어려운 버그가 생긴다. <br>
공유 객체 하나에는 메서드 하나만 사용할 것을 권장 <br>

현대 <br>
- @Transactional 로 원자적 연산 보장 
- 분산락 
- 이벤트 기반 아키텍처로 메서드 간 의존성 제거
- CQRS 패턴으로 읽기/쓰기 분리


### 6. 동기화하는 부분을 작게 만들어라
트랜잭션 범위 최소화 <br>
비동기 처리로 블로킹 최소화

### 7. 스레드 코드 테스트하기
일반적으로 동시성 버그는 재현하기 어렵다. <br>
문제를 노출하는 테스트 작성. <br>
프로그램 설정과 시스템 설정과 부하를 바꿔가며 자주 테스트 <br>
<br>
말이 안되는 실패는 잠정적인 스레드 문제로 취급 <br>

다중 스레드를 고려하지 않은 순차코드부터 제대로 동작하게 하기 <br>
-> 스레드 환경 밖에서 생기는 버그와 스레드 환경에서 생기는 버그를 동시에 디버깅하지 마라. 먼저 스레드 환경 밖에서 코드를 똑바로 돌려라
<br><br>

다중 스레드를 쓰는 코드 부분을 다양한 환경에 쉽게 끼워 넣을 수 있도록 스레드 코드를 구현하라. <br>
-> 다중 스레드를 쓰는 코드를 다양한 설정으로 실행하기 쉽게 구현하라
- 한 스레드로 실행하거나, 여러 스레드로 실행하거나, 실행 중 스레드 수를 바꾸거나
- 스레드 코드를 실제 환경이나 테스트 환경에서 돌려본다.
- 반복 테스트가 가능하도록 테스트 케이스를 작성
<br><br>
<br>

다중 스레드를 쓰는 코드 부분을 상황에 맞게 조율할 수 있게 작성하라